//@version=5
strategy("5min EMA/MA Strategy with Filters", overlay=true, margin_long=100, margin_short=100)

// 输入参数
ema_fast_len = input.int(5, "Fast EMA Length", minval=1)
ema_mid_len = input.int(20, "Middle EMA Length", minval=1)
ma_slow_len = input.int(60, "Slow MA Length", minval=1)
rsi_len = input.int(14, "RSI Length", minval=1)
rsi_overbought = input.int(65, "RSI Overbought", minval=50, maxval=90)
rsi_oversold = input.int(35, "RSI Oversold", minval=10, maxval=50)
volume_filter = input.bool(true, "Use Volume Filter")
volume_ma_len = input.int(20, "Volume MA Length", minval=5)
use_macd = input.bool(true, "Use MACD Filter")

// 计算指标
ema_fast = ta.ema(close, ema_fast_len)
ema_mid = ta.ema(close, ema_mid_len)
ma_slow = ta.sma(close, ma_slow_len)
rsi = ta.rsi(close, rsi_len)
vol_ma = ta.sma(volume, volume_ma_len)

// 计算MACD
[macd_line, signal_line, _] = ta.macd(close, 12, 26, 9)
macd_bullish = macd_line > signal_line
macd_bearish = macd_line < signal_line

// 条件判断
volume_ok = volume_filter ? volume > vol_ma : true
macd_ok_long = use_macd ? macd_bullish : true
macd_ok_short = use_macd ? macd_bearish : true

// 交易逻辑
long_condition = ta.crossover(ema_fast, ema_mid) and 
                 close > ma_slow and 
                 rsi > 50 and 
                 rsi < rsi_overbought and
                 volume_ok and
                 macd_ok_long

short_condition = ta.crossunder(ema_fast, ema_mid) and 
                  close < ma_slow and 
                  rsi < 50 and 
                  rsi > rsi_oversold and
                  volume_ok and
                  macd_ok_short

// 执行交易
if long_condition
    strategy.entry("Long", strategy.long)
    
if short_condition
    strategy.entry("Short", strategy.short)

// 止损和止盈（可根据需要调整）
stop_loss_percent = input.float(1.5, "Stop Loss %", minval=0.1, maxval=10) / 100
take_profit_percent = input.float(3.0, "Take Profit %", minval=0.5, maxval=15) / 100

if strategy.position_size > 0
    strategy.exit("Exit Long", "Long", stop=close * (1 - stop_loss_percent), limit=close * (1 + take_profit_percent))
    
if strategy.position_size < 0
    strategy.exit("Exit Short", "Short", stop=close * (1 + stop_loss_percent), limit=close * (1 - take_profit_percent))

// 绘制指标
plot(ema_fast, color=color.blue, linewidth=2, title="Fast EMA")
plot(ema_mid, color=color.orange, linewidth=2, title="Middle EMA")
plot(ma_slow, color=color.red, linewidth=2, title="Slow MA")

// 背景色警示
bgcolor(long_condition ? color.new(color.green, 90) : na)
bgcolor(short_condition ? color.new(color.red, 90) : na)