

import pandas as pd
import numpy as np
from datetime import datetime, timezone, timedelta

# ============ ç­–ç•¥å‚æ•° ============
# è¿™äº›å‚æ•°å¯ä»¥æ ¹æ®å›æµ‹ç»“æœè°ƒæ•´

EMA_SHORT = 9           # çŸ­æœŸEMAå‘¨æœŸ
EMA_LONG = 26           # é•¿æœŸEMAå‘¨æœŸ
RSI_PERIOD = 14         # RSIå‘¨æœŸ
RSI_OVERBOUGHT = 70     # RSIè¶…ä¹°çº¿
RSI_OVERSOLD = 30       # RSIè¶…å–çº¿
VOLUME_MA_PERIOD = 20   # æˆäº¤é‡å‡çº¿å‘¨æœŸ
VOLUME_THRESHOLD = 1.2  # æˆäº¤é‡é˜ˆå€¼ (1.2å€å‡å€¼)

# ============ æ ¸å¿ƒç­–ç•¥å‡½æ•° ============
def generate_signal(data):
    """
    ç”Ÿæˆäº¤æ˜“ä¿¡å·
    
    å‚æ•°:
        data: åŒ…å«Kçº¿æ•°æ®çš„å­—å…¸ {"price": float, "candles": list}
    
    è¿”å›:
        "buy": åšå¤šä¿¡å·
        "sell": åšç©ºä¿¡å·
        None: æ— ä¿¡å·
    """
    
    candles = data["candles"]
    
    # è‡³å°‘éœ€è¦50æ ¹Kçº¿æ‰èƒ½è®¡ç®—æŒ‡æ ‡
    if len(candles) < 50:
        return None
    
    # ========== æ•°æ®é¢„å¤„ç† ==========
    df = pd.DataFrame(
        candles,
        columns=["ts", "open", "high", "low", "close", "volume", "volCcy", "volCcyQuote", "confirm"]
    ).astype(float)
    
    # OKXè¿”å›çš„æ•°æ®æ˜¯ä»æ–°åˆ°æ—§,éœ€è¦åè½¬
    df = df.iloc[::-1].reset_index(drop=True)
    
    # ========== è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ ==========
    
    # 1. EMAå‡çº¿
    df['ema_short'] = df['close'].ewm(span=EMA_SHORT, adjust=False).mean()
    df['ema_long'] = df['close'].ewm(span=EMA_LONG, adjust=False).mean()
    
    # 2. RSIæŒ‡æ ‡
    df['rsi'] = calculate_rsi(df['close'], RSI_PERIOD)
    
    # 3. æˆäº¤é‡å‡çº¿
    df['volume_ma'] = df['volume'].rolling(window=VOLUME_MA_PERIOD).mean()
    
    # ========== è·å–æœ€æ–°æ•°æ® ==========
    current = df.iloc[-1]      # å½“å‰Kçº¿
    previous = df.iloc[-2]     # å‰ä¸€æ ¹Kçº¿
    
    close_price = current['close']
    ema_short = current['ema_short']
    ema_long = current['ema_long']
    ema_short_prev = previous['ema_short']
    ema_long_prev = previous['ema_long']
    rsi = current['rsi']
    volume = current['volume']
    volume_ma = current['volume_ma']
    
    # ========== æ‰“å°è°ƒè¯•ä¿¡æ¯ ==========
    print(f"\n{'='*60}")
    print(f"ã€ç­–ç•¥è°ƒè¯•ä¿¡æ¯ã€‘{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"{'='*60}")
    print(f"ä»·æ ¼: {close_price:.2f}")
    print(f"EMA{EMA_SHORT}: {ema_short:.2f} | EMA{EMA_LONG}: {ema_long:.2f}")
    print(f"RSI: {rsi:.2f}")
    print(f"æˆäº¤é‡: {volume:.2f} | å‡é‡: {volume_ma:.2f}")
    print(f"æˆäº¤é‡å€æ•°: {(volume/volume_ma):.2f}x")
    
    # ========== æ£€æµ‹å‡çº¿äº¤å‰ ==========
    golden_cross = (ema_short > ema_long) and (ema_short_prev <= ema_long_prev)
    death_cross = (ema_short < ema_long) and (ema_short_prev >= ema_long_prev)
    
    if golden_cross:
        print(f"ğŸŸ¢ æ£€æµ‹åˆ°é‡‘å‰!")
    if death_cross:
        print(f"ğŸ”´ æ£€æµ‹åˆ°æ­»å‰!")
    
    # ========== åšå¤šä¿¡å· ==========
    if golden_cross:
        # æ¡ä»¶1: é‡‘å‰
        print(f"âœ“ æ¡ä»¶1: é‡‘å‰ (EMA{EMA_SHORT}ä¸Šç©¿EMA{EMA_LONG})")
        
        # æ¡ä»¶2: ä»·æ ¼åœ¨EMAçŸ­æœŸä¸Šæ–¹
        price_above_ema = close_price > ema_short
        print(f"{'âœ“' if price_above_ema else 'âœ—'} æ¡ä»¶2: ä»·æ ¼åœ¨EMA{EMA_SHORT}ä¸Šæ–¹ ({close_price:.2f} > {ema_short:.2f})")
        
        # æ¡ä»¶3: RSIåœ¨å¼ºåŠ¿åŒº
        rsi_strong = rsi > 50
        print(f"{'âœ“' if rsi_strong else 'âœ—'} æ¡ä»¶3: RSIåœ¨å¼ºåŠ¿åŒº ({rsi:.2f} > 50)")
        
        # æ¡ä»¶4: æˆäº¤é‡æ”¾å¤§
        volume_confirm = volume > volume_ma * VOLUME_THRESHOLD
        print(f"{'âœ“' if volume_confirm else 'âœ—'} æ¡ä»¶4: æˆäº¤é‡æ”¾å¤§ ({volume/volume_ma:.2f}x > {VOLUME_THRESHOLD}x)")
        
        # æ¡ä»¶5: é¿å…è¶…ä¹°
        not_overbought = rsi < RSI_OVERBOUGHT
        print(f"{'âœ“' if not_overbought else 'âœ—'} æ¡ä»¶5: æœªè¶…ä¹° (RSI {rsi:.2f} < {RSI_OVERBOUGHT})")
        
        if price_above_ema and rsi_strong and volume_confirm and not_overbought:
            print(f"\nğŸš€ ã€åšå¤šä¿¡å·ã€‘æ‰€æœ‰æ¡ä»¶æ»¡è¶³!")
            print(f"{'='*60}\n")
            return "buy"
        else:
            print(f"\nâš ï¸  é‡‘å‰å‡ºç°ä½†è¿‡æ»¤æ¡ä»¶æœªæ»¡è¶³,ä¸å¼€ä»“")
            print(f"{'='*60}\n")
    
    # ========== åšç©ºä¿¡å· ==========
    elif death_cross:
        # æ¡ä»¶1: æ­»å‰
        print(f"âœ“ æ¡ä»¶1: æ­»å‰ (EMA{EMA_SHORT}ä¸‹ç©¿EMA{EMA_LONG})")
        
        # æ¡ä»¶2: ä»·æ ¼åœ¨EMAçŸ­æœŸä¸‹æ–¹
        price_below_ema = close_price < ema_short
        print(f"{'âœ“' if price_below_ema else 'âœ—'} æ¡ä»¶2: ä»·æ ¼åœ¨EMA{EMA_SHORT}ä¸‹æ–¹ ({close_price:.2f} < {ema_short:.2f})")
        
        # æ¡ä»¶3: RSIåœ¨å¼±åŠ¿åŒº
        rsi_weak = rsi < 50
        print(f"{'âœ“' if rsi_weak else 'âœ—'} æ¡ä»¶3: RSIåœ¨å¼±åŠ¿åŒº ({rsi:.2f} < 50)")
        
        # æ¡ä»¶4: æˆäº¤é‡æ”¾å¤§
        volume_confirm = volume > volume_ma * VOLUME_THRESHOLD
        print(f"{'âœ“' if volume_confirm else 'âœ—'} æ¡ä»¶4: æˆäº¤é‡æ”¾å¤§ ({volume/volume_ma:.2f}x > {VOLUME_THRESHOLD}x)")
        
        # æ¡ä»¶5: é¿å…è¶…å–
        not_oversold = rsi > RSI_OVERSOLD
        print(f"{'âœ“' if not_oversold else 'âœ—'} æ¡ä»¶5: æœªè¶…å– (RSI {rsi:.2f} > {RSI_OVERSOLD})")
        
        if price_below_ema and rsi_weak and volume_confirm and not_oversold:
            print(f"\nğŸ“‰ ã€åšç©ºä¿¡å·ã€‘æ‰€æœ‰æ¡ä»¶æ»¡è¶³!")
            print(f"{'='*60}\n")
            return "sell"
        else:
            print(f"\nâš ï¸  æ­»å‰å‡ºç°ä½†è¿‡æ»¤æ¡ä»¶æœªæ»¡è¶³,ä¸å¼€ä»“")
            print(f"{'='*60}\n")
    
    else:
        # æ— äº¤å‰ä¿¡å·
        trend = "ä¸Šå‡" if ema_short > ema_long else "ä¸‹é™"
        print(f"ğŸ“Š å½“å‰è¶‹åŠ¿: {trend} (æ— äº¤å‰ä¿¡å·)")
        print(f"{'='*60}\n")
    
    return None


# ============ è¾…åŠ©å‡½æ•° ============
def calculate_rsi(prices, period=14):
    """
    è®¡ç®—RSIæŒ‡æ ‡
    
    å‚æ•°:
        prices: ä»·æ ¼åºåˆ— (pandas Series)
        period: RSIå‘¨æœŸ
    
    è¿”å›:
        RSIå€¼åºåˆ—
    """
    delta = prices.diff()
    
    gain = delta.where(delta > 0, 0)
    loss = -delta.where(delta < 0, 0)
    
    avg_gain = gain.rolling(window=period, min_periods=period).mean()
    avg_loss = loss.rolling(window=period, min_periods=period).mean()
    
    rs = avg_gain / avg_loss
    rsi = 100 - (100 / (1 + rs))
    
    return rsi

